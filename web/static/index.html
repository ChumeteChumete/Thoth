<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thoth Chat</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="app-container">
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Thoth Chat</h2>
                <div class="room-info">
                    –ö–æ–º–Ω–∞—Ç–∞: <span id="room-display">-</span>
                </div>
            </div>
            <div class="users-list">
                <h3>–û–Ω–ª–∞–π–Ω (<span id="users-count">0</span>)</h3>
                <div id="users-container"></div>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å -->
        <div class="main-content">
            <div class="chat-header">
                <div class="chat-title">
                    <span id="username-display">–ì–æ—Å—Ç—å</span>
                </div>
                <div class="video-controls">
                    <button class="video-btn" id="videoToggle">üìπ –í–∏–¥–µ–æ</button>
                    <button class="video-btn" id="audioToggle">üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω</button>
                </div>
            </div>

            <div class="video-area" id="videoArea">
                <div class="video-container">
                    <video class="video-stream" id="localVideo" autoplay muted playsinline></video>
                    <div class="video-label">–í—ã</div>
                </div>
            </div>

            <div class="messages-area" id="messages"></div>

            <div class="input-area">
                <div class="input-container">
                    <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" disabled>
                    <button id="sendBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ -->
    <div class="connection-overlay" id="connectionOverlay">
        <div class="connection-form">
            <h2>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —á–∞—Ç—É</h2>
            <div class="form-group">
                <label for="usernameInput">–í–∞—à–µ –∏–º—è</label>
                <input type="text" id="usernameInput" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" value="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å">
            </div>
            <div class="form-group">
                <label for="roomInput">–ö–æ–º–Ω–∞—Ç–∞</label>
                <input type="text" id="roomInput" class="form-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã" value="general">
            </div>
            <button id="connectBtn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        </div>
    </div>

    <!-- –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π JS -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            class ThothChatClient {
                constructor() {
                    this.ws = null;
                    this.username = '';
                    this.room = '';
                    this.isConnected = false;
                    this.localStream = null;
                    this.onlineUsers = new Set();

                    this.initElements();
                    this.bindEvents();
                }

                initElements() {
                    this.messagesContainer = document.getElementById('messages');
                    this.messageInput = document.getElementById('messageInput');
                    this.sendBtn = document.getElementById('sendBtn');
                    this.connectBtn = document.getElementById('connectBtn');
                    this.usernameInput = document.getElementById('usernameInput');
                    this.roomInput = document.getElementById('roomInput');
                    this.connectionOverlay = document.getElementById('connectionOverlay');
                    this.usernameDisplay = document.getElementById('username-display');
                    this.roomDisplay = document.getElementById('room-display');
                    this.usersContainer = document.getElementById('users-container');
                    this.usersCount = document.getElementById('users-count');
                    this.videoToggle = document.getElementById('videoToggle');
                    this.audioToggle = document.getElementById('audioToggle');
                    this.videoArea = document.getElementById('videoArea');
                    this.localVideo = document.getElementById('localVideo');
                }

                bindEvents() {
                    this.connectBtn.addEventListener('click', () => this.connect());
                    this.sendBtn.addEventListener('click', () => this.sendMessage());
                    this.messageInput.addEventListener('keypress', e => {
                        if (e.key === 'Enter') this.sendMessage();
                    });
                    this.videoToggle.addEventListener('click', () => this.toggleVideo());
                    this.audioToggle.addEventListener('click', () => this.toggleAudio());
                }

                connect() {
                    if (this.ws && (this.isConnected || this.ws.readyState === WebSocket.CONNECTING)) return;
                    if (this.ws) this.ws.close();

                    this.username = this.usernameInput.value.trim() || '–ê–Ω–æ–Ω–∏–º';
                    this.room = this.roomInput.value.trim() || 'general';

                    const wsUrl = `wss://${location.host}/ws?username=${encodeURIComponent(this.username)}&room=${encodeURIComponent(this.room)}`;

                    try {
                        this.ws = new WebSocket(wsUrl);

                        this.ws.onopen = () => this.onConnected();
                        this.ws.onmessage = (e) => this.handleMessage(JSON.parse(e.data));
                        this.ws.onclose = () => this.onDisconnected();
                        this.ws.onerror = (err) => {
                            console.error('WebSocket error:', err);
                            this.onDisconnected();
                        };
                    } catch (err) {
                        console.error('–û—à–∏–±–∫–∞ WebSocket:', err);
                        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è');
                    }
                }

                onConnected() {
                    this.isConnected = true;
                    this.connectionOverlay.classList.add('hidden');
                    this.messageInput.disabled = false;
                    this.sendBtn.disabled = false;
                    this.usernameDisplay.textContent = this.username;
                    this.roomDisplay.textContent = this.room;
                    this.addSystemMessage(`–ü–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ "${this.room}"`);
                    this.addUser(this.username);
                }

                onDisconnected() {
                    this.isConnected = false;
                    this.ws = null;
                    this.messageInput.disabled = true;
                    this.sendBtn.disabled = true;
                    this.addSystemMessage('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ');
                    this.onlineUsers.clear();
                    this.updateUsersList();
                }

                sendMessage() {
                    if (!this.isConnected || !this.messageInput.value.trim()) return;
                    const message = {
                        type: 'chat',
                        content: this.messageInput.value.trim(),
                        timestamp: new Date().toISOString()
                    };
                    this.ws.send(JSON.stringify(message));
                    this.messageInput.value = '';
                }

                handleMessage(data) {
                    if (data.type === 'chat') {
                        this.displayMessage(data);
                    } else if (data.type === 'user_joined') {
                        this.addUser(data.username);
                        this.addSystemMessage(`${data.username} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è`);
                    } else if (data.type === 'user_left') {
                        this.removeUser(data.username);
                        this.addSystemMessage(`${data.username} –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç`);
                    } else if (data.type === 'users_list') {
                        try {
                            const users = JSON.parse(data.content);
                            this.onlineUsers.clear();
                            users.forEach(u => this.onlineUsers.add(u));
                            this.updateUsersList();
                        } catch (err) {
                            console.error('–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ users_list:', err);
                        }
                    }
                }

                addUser(username) {
                    this.onlineUsers.add(username);
                    this.updateUsersList();
                }

                removeUser(username) {
                    this.onlineUsers.delete(username);
                    this.updateUsersList();
                }

                updateUsersList() {
                    this.usersCount.textContent = this.onlineUsers.size;
                    this.usersContainer.innerHTML = '';
                    Array.from(this.onlineUsers).sort().forEach(username => {
                        const el = document.createElement('div');
                        el.className = 'user-item';
                        el.innerHTML = `
                            <div class="user-avatar">${username.charAt(0).toUpperCase()}</div>
                            <span>${username}</span>
                            <div class="user-status"></div>`;
                        this.usersContainer.appendChild(el);
                    });
                }

                displayMessage(msg) {
                    const el = document.createElement('div');
                    el.className = `message ${msg.username === this.username ? 'own' : ''}`;
                    const time = new Date(msg.timestamp).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                    el.innerHTML = `
                        <div class="message-bubble">
                            <div class="message-header">
                                <span>${msg.username}</span>
                                <span>${time}</span>
                            </div>
                            <div class="message-content">${this.escapeHtml(msg.content)}</div>
                        </div>`;
                    this.messagesContainer.appendChild(el);
                    this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
                }

                addSystemMessage(text) {
                    const el = document.createElement('div');
                    el.className = 'system-message';
                    el.textContent = text;
                    this.messagesContainer.appendChild(el);
                    this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
                }

                async toggleVideo() {
                    if (!this.localStream) {
                        try {
                            this.localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                            this.localVideo.srcObject = this.localStream;
                            this.videoArea.classList.add('active');
                            this.videoToggle.classList.add('active');
                            this.videoToggle.textContent = 'üìπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–∏–¥–µ–æ';
                            this.addSystemMessage('–í–∏–¥–µ–æ –≤–∫–ª—é—á–µ–Ω–æ');
                        } catch (err) {
                            console.error('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:', err);
                            alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ');
                        }
                    } else {
                        this.localStream.getTracks().forEach(t => t.stop());
                        this.localStream = null;
                        this.localVideo.srcObject = null;
                        this.videoArea.classList.remove('active');
                        this.videoToggle.classList.remove('active');
                        this.videoToggle.textContent = 'üìπ –í–∏–¥–µ–æ';
                        this.addSystemMessage('–í–∏–¥–µ–æ –≤—ã–∫–ª—é—á–µ–Ω–æ');
                    }
                }

                toggleAudio() {
                    if (this.localStream) {
                        const audio = this.localStream.getAudioTracks()[0];
                        if (audio) {
                            audio.enabled = !audio.enabled;
                            this.audioToggle.classList.toggle('active', audio.enabled);
                            this.audioToggle.textContent = audio.enabled ? 'üé§ –í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω' : 'üé§ –í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω';
                        }
                    }
                }

                escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }
            }

            new ThothChatClient();
        });
    </script>
</body>
</html>
